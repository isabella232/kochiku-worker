#!/bin/sh

set -e
set -x

WORKER_DIR=/data/app/kochiku-worker/current
queues=ci-sjc1,developer-sjc1

# XXX: todo, stop using system ruby
export PATH=/usr/ruby20/bin:$PATH

cd $WORKER_DIR

if [[ -f ./config/kochiku-worker.yml.sjc1 ]];then
  cp ./config/kochiku-worker.yml ./config/kochiku-worker.yml.development
  mv ./config/kochiku-worker.yml.sjc1 ./config/kochiku-worker.yml
fi

exec setsid /usr/ruby20/bin/bundle exec rake resque:work \
  --trace QUEUES=${queues:-"*"} TERM_CHILD=1 INTERVAL=15 </dev/null
