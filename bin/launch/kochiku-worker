#!/bin/sh

set -ex

export HOME=/data/app/kochiku-worker

cd $(dirname $0)/../../

# add git executable to the path
export PATH=$(pwd)/bin:$PATH

mkdir -p tmp/build-partition

# Extract the resque queues from the p2 manifest config
queues=$(./ruby/bin/ruby -ryaml -e '$a=YAML.load_file(ENV["CONFIG_PATH"]); print $a.fetch("resque").fetch("queues")')

exec setsid ./ruby/bin/rake resque:work \
  --trace QUEUES=${queues} TERM_CHILD=1 INTERVAL=15
