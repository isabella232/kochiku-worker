#!/bin/sh

set -ex

export HOME=/data/app/kochiku-worker

export HTTPS_PROXY=http://$USER:$HOSTNAME@webproxy.vip:3128
export HTTP_PROXY=http://$USER:$HOSTNAME@webproxy.vip:3128
export http_proxy=http://$USER:$HOSTNAME@webproxy.vip:3128
export https_proxy=http://$USER:$HOSTNAME@webproxy.vip:3128
export no_proxy='vip,square,corp.squareup.com,localhost,127.0.0.1'

cd $(dirname $0)/../../

# add git executable to the path
export PATH=$(pwd)/bin:$PATH

mkdir -p tmp/build-partition

# cleanup any temp build directories that may have been orphaned by an unclean
# exit of kochiku-worker. Safe to do under the assumption of 1 worker per
# machine.
find tmp/build-partition -maxdepth 1 -name 'd20[0-9]*' -type d -print0 | xargs -0 -t -n1 rm -rf

# Extract the resque queues from the p2 manifest config
queues=$(./ruby/bin/ruby -ryaml -e '$a=YAML.load_file(ENV["CONFIG_PATH"]); print $a.fetch("resque").fetch("queues")')

exec ./bundle/ruby/2.4.0/bin/rake resque:work \
  --trace QUEUES=${queues} TERM_CHILD=1 INTERVAL=15
